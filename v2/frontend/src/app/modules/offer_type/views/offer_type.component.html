<!--
   Copyright 2020 Google LLC

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0
 
   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->

<h2 class="main_title">Offer Types</h2>

<div class="inner_content">
  
  <!-- First screen: choose to edit or create new -->
  <div *ngIf="step == 1">
    
    <h2>Your available offer types:</h2>

    <mat-spinner *ngIf="bases.length == 0"></mat-spinner>
    
    <div *ngIf="bases.length > 0">

      <!-- Search term -->
      <mat-form-field class="example-full-width">
        <mat-label>Search offer types</mat-label>
        <input name="search_term" #search_term matInput>
      </mat-form-field>

      <br/>

      <div class="added_item" *ngFor="let offer of offer_types | async | filter : search_term.value | sortBy: 'asc':'title' | sortBy: 'asc':'base'">
        
        <p><b>{{offer.title}}</b></p>
        <p>({{offer.base}})</p>
        
        <span style="cursor: pointer" (click)="edit_type(offer)" >
          <mat-icon aria-hidden="false" aria-label="edit icon" title="Edit">edit</mat-icon>
        </span>
        
        <span style="cursor: pointer" (click)="copy_type(offer)">
          <mat-icon aria-hidden="false" aria-label="copy icon" title="Copy">file_copy</mat-icon>
        </span>
        
        <span style="cursor: pointer" (click)="delete_type(offer)">
          <mat-icon aria-hidden="false" aria-label="delete icon" title="Delete">delete</mat-icon>
        </span>
      </div>
    </div>
    
    <br/><br/>
    
    <button mat-stroked-button (click)="move_step(2)">Create new offer type</button>
  </div>
  
  <!-- Second screen: select base to create new -->
  <div *ngIf="step == 2">
    
    <h2>Select base to use:</h2>
    <mat-spinner *ngIf="bases.length == 0"></mat-spinner>
    
    <div class="added_item" *ngFor="let base of bases" (click)="choose_base(base)">
      <p>{{base.title}}</p>
    </div>
  </div>
  
  <!-- Configure chosen base -->
  <div [hidden]="!base_url">
    
      <h2>How to configure offer type?</h2>

      <p>This is where you place elements like images and texts on your base.</p>
      <p>Drag and Drop elements to position them on screen. Use double-click to delete elements.</p>
      <p>"Product" elements are dynamic and replaced when generating preview/ads during next step.</p>
      <p>Values you choose under "Products" elements are just examples texts/images.</p>
      <p>"Assets" elements are static and fixed, so will stay as you see here.</p>
      <p>The selected color for the inserted texts will be applied when the element is dragged and dropped in the base area.</p>
      <br/>

      <!-- Spinner -->
      <mat-spinner class="spinner-element" style="position: absolute" *ngIf="base_url && !base_asset"></mat-spinner>
  
      <div class="asset-container">

        <!-- If it's video base -->
        <video #vd1 *ngIf="base_url && is_video" class="video" (loadedmetadata)="on_video_loaded(vd1)" muted>
          <source [src]="base_url" type="video/mp4">
        </video>

        <!-- Or if it's image base -->
        <img #img1 *ngIf="base_url && !is_video" (load)="on_image_loaded(img1)" [src]="base_url"/>

        <app-draggable-element *ngFor="let el of elements"
          [element]="el"
          [video_pos]="base_specs"
          (dblclick)="delete_element($event)"
          (dragEnd)="drag_end($event)"
          (singleclick)="focus_element($event)">
        </app-draggable-element>

      </div>

      <!-- Box to edit elements on screen -->
      <div class="edit_box" *ngIf="element_focused" cdkDrag>

        <div style="text-align: center; margin-top: 5%; font-weight: bold;">{{element_focused.field}} ({{element_focused.type}})</div>

        <!-- Box to edit text element -->
        <div [hidden]="element_focused.view_type != 'text'"> 

          <input [(ngModel)]="element_focused.color"
          [style.background]="element_focused.color"
          [(colorPicker)]="element_focused.color" />
          
          <br/>

          <mat-form-field class="example-full-width">
            <mat-label>Font size</mat-label>
            <input [(ngModel)]="element_focused.size" type="number" matInput placeholder="size">
          </mat-form-field>
          
          <br/>

          <mat-form-field class="example-full-width">
            <mat-label>Width (letters)</mat-label>
            <input [(ngModel)]="element_focused.width" (change)="on_change_text_width(element_focused)" type="number" matInput placeholder="width">
          </mat-form-field>
          
          <br/>

          <mat-form-field>
            <mat-label>Align</mat-label>
            <mat-select [(ngModel)]="element_focused.align" value="center">
              <mat-option *ngFor="let a of ['center', 'left', 'right']" [value]="a">
                {{a}}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <br/>

          <!--mat-checkbox class="example-margin" style="margin-left: 2%;" [(ngModel)]="element_focused.keep_ratio">
            Fit text
          </mat-checkbox>

          <br/>

          <mat-form-field *ngIf="element_focused.keep_ratio" class="example-full-width">
            <mat-label>Lines to fill</mat-label>
            <input [(ngModel)]="element_focused.height" type="number" matInput placeholder="lines">
          </mat-form-field-->

          <button mat-stroked-button style="width: 100%" (click)="send_to_back(element_focused)">Send to back</button>

        </div>

        <!-- Box to edit image element -->
        <div [hidden]="element_focused.view_type != 'image'"> 

          <mat-form-field class="example-full-width">
            <mat-label>Width</mat-label>
            <input [(ngModel)]="element_focused.width" type="number" matInput placeholder="width">
          </mat-form-field>

          <br/>

          <mat-form-field class="example-full-width">
            <mat-label>Height</mat-label>
            <input [(ngModel)]="element_focused.height" type="number" matInput placeholder="height">
          </mat-form-field>

          <br/>

          <button mat-stroked-button style="width: 100%" (click)="send_to_back(element_focused)">Send to back</button>

        </div>
      </div>
        
      <br><br>
      
      <!-- Offer Type -->
      <mat-form-field class="example-full-width">
        <mat-label>Title</mat-label>
        <input [(ngModel)]="offer_type.title" matInput [disabled]="locked_name">
      </mat-form-field>

      <!-- Product to be shown -->
      <mat-form-field class="example-full-width">
        <mat-label>Product (view)</mat-label>
        <mat-select [(ngModel)]="product_shown" (selectionChange)="choose_product_shown()" [disabled]="!base_asset">
          <mat-option *ngFor="let product of facade.products" [value]="product.id">
            ({{product.id}}) {{product.values['Title']}}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Add New Items -->
      <h2>Add new element to base:</h2>
      
      <!-- Choose type -->
      <mat-form-field>
        <mat-label>Insert new</mat-label>
        <mat-select [(ngModel)]="config.type" (selectionChange)="select_type(config.type)">
          <mat-option *ngFor="let type of ['product', 'asset']" [value]="type">
            {{type}}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <!-- Choose field -->
      <mat-form-field *ngIf="config.type">
        <mat-label>Field</mat-label>
        <mat-select [(ngModel)]="config.field" (selectionChange)="select_field(config.field)">
          <mat-option *ngFor="let field of fields" [value]="field">
            {{field}}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <!-- Content to place on top of base -->
      <mat-form-field *ngIf="config.field">
        <mat-label>Value</mat-label>
        <mat-select [(ngModel)]="content" (selectionChange)="select_example(content)">
          <mat-option *ngFor="let content of contents" [value]="content">
            {{is_image(content.value) ? content.value.split('/').pop() : content.value}}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <br/>
      
      <!-- Choosen elements to add -->
      <div *ngIf="config.key">
        
        <!-- Text -->
        <div *ngIf="!is_image(content.value)">
          
          <mat-form-field>
            <mat-label>Font</mat-label>
            <mat-select [(ngModel)]="config.font">
              <mat-option *ngFor="let f of facade.fonts | keyvalue" [value]="f.key">
                {{f.key}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          
          <input [(ngModel)]="config.color"
          [style.background]="config.color"
          [(colorPicker)]="config.color"/>
          
          <mat-form-field class="example-full-width">
            <mat-label>Font size</mat-label>
            <input [(ngModel)]="config.size" type="number" matInput placeholder="size">
          </mat-form-field>
          
          <mat-form-field class="example-full-width">
            <mat-label>Width (letters)</mat-label>
            <input [(ngModel)]="config.width" type="number" matInput placeholder="width">
          </mat-form-field>
          
          <mat-form-field>
            <mat-label>Align</mat-label>
            <mat-select [(ngModel)]="config.align" value="center">
              <mat-option *ngFor="let a of ['center', 'left', 'right']" [value]="a">
                {{a}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-checkbox class="example-margin" style="margin-left: 2%;" [(ngModel)]="config.flip">
            Flip
          </mat-checkbox>
          
          <!--mat-checkbox class="example-margin" style="margin-left: 2%;" [(ngModel)]="config.keep_ratio">
            Fit text
          </mat-checkbox>

          <mat-form-field *ngIf="config.keep_ratio" class="example-full-width">
            <mat-label>Lines to fill</mat-label>
            <input [(ngModel)]="config.height" type="number" matInput placeholder="lines">
          </mat-form-field-->

          <br/>
          
          <button mat-stroked-button (click)="create_text()">Insert Text</button>
        </div>
        
        <!-- Image -->
        <div *ngIf="is_image(content.value)">
          
          <mat-form-field class="example-full-width">
            <mat-label>Width</mat-label>
            <input [(ngModel)]="config.width" type="number" matInput placeholder="width">
          </mat-form-field>
          
          <mat-form-field class="example-full-width">
            <mat-label>Height</mat-label>
            <input [(ngModel)]="config.height" type="number" matInput placeholder="height">
          </mat-form-field>
          
          <!--mat-form-field class="example-full-width">
            <mat-label>Angle</mat-label>
            <input [(ngModel)]="config.angle" type="number" min=-90 max=90 matInput placeholder="angle">
          </mat-form-field-->

          <mat-checkbox class="example-margin" style="margin-left: 2%;" [(ngModel)]="config.flip">
            Flip
          </mat-checkbox>

          <mat-checkbox class="example-margin" style="margin-left: 2%;" [(ngModel)]="config.keep_ratio">
            Keep Ratio
          </mat-checkbox>

          <br/>
          
          <button mat-stroked-button (click)="create_image()">Insert Image</button>
        </div>
      </div>

      <!-- Products positions -->
      <div *ngIf="base_asset && is_video">

        <h2>Position:</h2>

          <p>This position is to visualization only.<br/>You can assign each product to each position when creating the video on next step.</p>

          <div class="added_item" *ngFor="let product of base_products_timings; let i = index" (click)="choose_position(product)" style="min-width: 0; width: 6vw">
              <p>Position {{i + 1}}</p>
              <p>{{product.start_time}}s - {{product.end_time}}s</p>
          </div>
      </div>

      <br/><br/>
      
      <button mat-stroked-button [disabled]="locked_save" (click)="finish()">Save</button>
      <a style="margin-left: 1%;" mat-stroked-button (click)="ngOnInit()">Cancel</a>
</div>